<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyborg AI Agentic</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">

    <!-- Trunk directives -->
    <style type="text/css">
        /* Base styles */
        html, body {
            overflow: hidden;
            margin: 0 !important;
            padding: 0 !important;
            height: 100%;
            width: 100%;
            background: #1a1a1a;
        }

        /* Canvas for egui app */
        canvas {
            margin-right: auto;
            margin-left: auto;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Loading screen container */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Logo */
        #loading-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        /* Loading text */
        #loading-text {
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 18px;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* Progress bar container */
        #progress-container {
            width: 300px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        /* Progress bar fill */
        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #00d4aa);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Progress percentage text */
        #progress-text {
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 14px;
        }

        /* Spinner for indeterminate loading */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Error message styling */
        #error-message {
            display: none;
            color: #ff6b6b;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            max-width: 400px;
        }
    </style>

    <!-- Preload assets - removed integrity hashes for GitHub Pages compatibility -->
    <link rel="modulepreload" href="./assets/wasm/app_cyborgai-c18ecea9b0034051.js" crossorigin="anonymous">
    <link rel="preload" href="./assets/wasm/app_cyborgai-c18ecea9b0034051_bg.wasm" crossorigin="anonymous" as="fetch" type="application/wasm">
</head>

<body>
<!-- Loading screen -->
<div id="loading-screen">
    <img id="loading-logo" src="./assets/images/logo.png" alt="Cyborg AI Agentic Logo"/>
    <div id="loading-text">Loading Cyborg AI Agentic...</div>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <div id="progress-text">0%</div>
    <div class="spinner"></div>
    <div id="error-message"></div>
</div>

<!-- Canvas for egui app -->
<canvas id="canvas"></canvas>

<script>
    // Simulate loading progress while WASM loads
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const loadingScreen = document.getElementById('loading-screen');
    const errorMessage = document.getElementById('error-message');

    // Simulate progress (WASM loading doesn't provide real progress)
    const simulateProgress = () => {
        if (progress < 90) {
            // Slow down as we approach 90%
            const increment = Math.max(1, (90 - progress) / 10);
            progress += increment;
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
            setTimeout(simulateProgress, 100 + Math.random() * 200);
        }
    };

    // Start simulating progress
    simulateProgress();

    // Function to hide loading screen (called when WASM is ready)
    window.hideLoadingScreen = function () {
        progress = 100;
        progressBar.style.width = '100%';
        progressText.textContent = '100%';

        setTimeout(() => {
            loadingScreen.classList.add('hidden');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }, 300);
    };

    // Function to show error
    window.showLoadingError = function(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        document.querySelector('.spinner').style.display = 'none';
    };

    // Fallback: hide loading screen after timeout if WASM doesn't call hideLoadingScreen
    setTimeout(() => {
        if (!loadingScreen.classList.contains('hidden')) {
            window.hideLoadingScreen();
        }
    }, 15000); // 15 second timeout
</script>

<script type="module">
    // Use consistent relative paths for GitHub Pages
    const wasmJsPath = './assets/wasm/app_cyborgai-c18ecea9b0034051.js';
    const wasmBinaryPath = './assets/wasm/app_cyborgai-c18ecea9b0034051_bg.wasm';

    try {
        // Dynamic import with relative path
        const module = await import(wasmJsPath);
        const init = module.default;
        const bindings = module;

        // Fetch WASM as ArrayBuffer to avoid MIME type issues on GitHub Pages
        const wasmResponse = await fetch(wasmBinaryPath);

        if (!wasmResponse.ok) {
            throw new Error(`Failed to fetch WASM: ${wasmResponse.status} ${wasmResponse.statusText}`);
        }

        const wasmBytes = await wasmResponse.arrayBuffer();

        // Initialize with ArrayBuffer instead of URL
        const wasm = await init(wasmBytes);

        window.wasmBindings = bindings;

        dispatchEvent(new CustomEvent("TrunkApplicationStarted", { detail: { wasm } }));

        // Hide loading screen on successful load
        if (window.hideLoadingScreen) {
            window.hideLoadingScreen();
        }

    } catch (error) {
        console.error('Failed to load WASM:', error);

        if (window.showLoadingError) {
            window.showLoadingError(`Failed to load application: ${error.message}`);
        }
    }
</script>
</body>

</html>